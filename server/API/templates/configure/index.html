
{% extends "base.html" %}
{% load i18n %}

{% block title %}GrouponX - Create your ads configuration{% endblock %}

{% block content %}
<style>

/*  bhoechie tab */
div.bhoechie-tab-container{
  z-index: 10;
  background-color: #ffffff;
  padding: 0 !important;
  border-radius: 4px;
  -moz-border-radius: 4px;
  border:1px solid #ddd;
  margin-top: 20px;
  margin-left: 50px;
  -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
  box-shadow: 0 6px 12px rgba(0,0,0,.175);
  -moz-box-shadow: 0 6px 12px rgba(0,0,0,.175);
  background-clip: padding-box;
  opacity: 0.97;
  filter: alpha(opacity=97);
}
div.bhoechie-tab-menu{
  padding-right: 0;
  padding-left: 0;
  padding-bottom: 0;
}
div.bhoechie-tab-menu div.list-group{
  margin-bottom: 0;
}
div.bhoechie-tab-menu div.list-group>a{
  margin-bottom: 0;
}
div.bhoechie-tab-menu div.list-group>a .glyphicon,
div.bhoechie-tab-menu div.list-group>a .fa {
  color: #356BA7;
}
div.bhoechie-tab-menu div.list-group>a:first-child{
  border-top-right-radius: 0;
  -moz-border-top-right-radius: 0;
}
div.bhoechie-tab-menu div.list-group>a:last-child{
  border-bottom-right-radius: 0;
  -moz-border-bottom-right-radius: 0;
}
div.bhoechie-tab-menu div.list-group>a.active,
div.bhoechie-tab-menu div.list-group>a.active .glyphicon,
div.bhoechie-tab-menu div.list-group>a.active .fa{
  background-color: #356BA7;
  background-image: #356BA7;
  color: #ffffff;
}
div.bhoechie-tab-menu div.list-group>a.active:after{
  content: '';
  position: absolute;
  left: 100%;
  top: 50%;
  margin-top: -13px;
  border-left: 0;
  border-bottom: 13px solid transparent;
  border-top: 13px solid transparent;
  border-left: 10px solid #356BA7;
}

div.bhoechie-tab-content{
  background-color: #ffffff;
  /* border: 1px solid #eeeeee; */
  padding-left: 20px;
  padding-top: 10px;
}

div.bhoechie-tab div.bhoechie-tab-content:not(.active){
  display: none;
}

  .configuration-box {
    width: 800px;
  }

  .siteid-box {
    box-shadow: 0px 1px 4px 0px rgba(0,0,0,0.2);
    padding: 15px;
    margin: 5px;
  }
  
  .page-box {
    box-shadow: 0px 1px 4px 0px rgba(0,0,0,0.2);
    padding: 20px;
    margin: 10px;
  }

  .config-box {
    box-shadow: 0px 1px 4px 0px rgba(0,0,0,0.2);
    padding: 20px;
    margin: 10px;
  }

  .section {
    margin: 10px 0;
  }

  .section-header {
    border-bottom: 1px black solid;
    font-size: larger;
    margin-bottom: 15px;
    padding-bottom: 5px;
  }

  .radio-box {
    margin-right: 10px;
  }

  .radio-box input {
    margin-right: 10px;
  }

  .layout-box {
    overflow: hidden;
    display: inline-block;
    width: 25%;
    height: 300px;
    padding: 10px;
    margin: 10px;
  }
</style>

<div class="container">
	<div class="row">
        <div class="col-lg-10 col-md-5 col-sm-8 col-xs-9 bhoechie-tab-container">
            <div class="col-lg-1 col-md-3 col-sm-3 col-xs-3 bhoechie-tab-menu">
              <div class="list-group">
                <a href="#" class="list-group-item active text-center">
                  <h4 class=""></h4><br/>untilted page
                </a>
                <a href="#" class="list-group-item text-center">
                  <h4 class="glyphicon glyphicon-plus-sign"></h4><br/>
                </a>
              </div>
            </div>
            <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9 bhoechie-tab">
                <!-- flight section -->
                <div class="bhoechie-tab-content active">
                    <div class="configuration-box">
                      <div class="siteid-box">
                        <label style="margin-bottom: 15px">SiteID <font face="verdana" size="2">{{ user.site.hash }}</label>
                      </div>
                      <div class="page-box">
                        <button id="add-configuration-button" style="margin-bottom: 15px">Add Configuration</button>
                      </div>

                      <div class="config-box">
                        <!-- Bid strategy -->
                        <div class="section">
                          <div class="section-header">Bid Strategy</div>
                          <div>
                        <span class="radio-box">
                          <input type="radio" name="strategy" value="0">Default
                          Bidding Strategy, location based.
                        </span>
                          </div>
                          <div>
                        <span class="radio-box">
                          <input type="radio" name="strategy" value="1">Max Discount
                          Bidding Strategy, Coupons will be sorted based the order of
                          discount value.
                        </span>
                          </div>
                          <div>
                        <span class="radio-box">
                          <input type="radio" name="strategy" value="2">Most Expensive
                          Bidding Strategy, Coupons will be sorted based the selling
                          price.
                        </span>
                          </div>

                        </div>

                        <!-- Black/White list -->
                        <div class="section">
                          <div class="section-header">Site control</div>
                          <div id="whitelist">
                        <span class="radio-box">
                          <input type="radio" name="listing" value="whitelist" size="10">Whitelist
                        </span>
                        <input type="text" size="80">
                          </div>
                          <div id="blacklist">
                        <span class="radio-box">
                          <input type="radio" name="listing" value="blacklist">Blacklist
                        </span>
                        <input type="text" size="80" disabled>
                          </div>
                        </div>

                        <!-- Layout option -->
                        <div class="section">
                          <div class="section-header">Layout</div>
                          <div>Select city to preview:
                        <select id="city">
                          <option value="58.30.15.255">Beijing</option>
                          <option value="58.24.23.255 ">Shanghai</option>
			  <option value="202.193.16.3">Guilin</option>
			  <option value="58.60.5.57">Shenzhen</option>
			  <option value="222.210.18.2">Chengdu</option>
			  <option value="222.247.60.114">Changsha</option>
                        </select>
                        <span id="preview" style="display: none; margin-left: 50px">Updating preview... Please wait.</span>
                          </div>
                          <div class="layout-box" id="target">
                        <div class="radio-box">
                          <input type="radio" name="layout" value="0">Static
                        </div>
                          </div>
                          <div class="layout-box" id="target2">
                        <div class="radio-box">
                          <input type="radio" name="layout" value="1">Fade In/Out
                        </div>
                          </div>
                          <div class="layout-box" id="target3">
                        <div class="radio-box">
                          <input type="radio" name="layout" value="2">Merry-Go-Round
                        </div>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>

            </div>
        </div>
  </div>
</div>



<script type="text/javascript">
$(document).ready(function() {
    $("div.bhoechie-tab-menu>div.list-group>a").click(function(e) {
        e.preventDefault();
        $(this).siblings('a.active').removeClass("active");
        $(this).addClass("active");
        var index = $(this).index();
        $("div.bhoechie-tab>div.bhoechie-tab-content").removeClass("active");
        $("div.bhoechie-tab>div.bhoechie-tab-content").eq(index).addClass("active");
    });
});

  function createPage() {
    var fakeCreatePageResposne = {
      "status": "ok",
      "data": {
        "p_id": "0",
      },
      "error": ""
    }
  }

  function readPageList() {

  }

  function readPage(page) {

  }

  function savePage(page) {

  }

  function createConfig(page) {
    var fakeCreateConfigResponse = {
      "status": "ok",
      "data": {
        "id": 0,
        "bid_strategy": 0,
        "whitelist": "whitelist_site_1, whitelist_site_2",
        "blacklist": "",
        "layout": 0
      },
      "error": ""
    }
  }

  function enableAndSetList(list_name, val) {
    $("input[name='listing'][value='" + list_name + "']").prop("checked", true);
    $("#" + list_name + " input[type='text']").prop("disabled", false);
    $("#" + list_name + " input[type='text']").val(val);
  }

  function disableList(list_name) {
    $("#" + list_name + " input[type='text']").prop("disabled", true);
    $("#" + list_name + " input[type='text']").val("");
  }

  function loadConfig(page, config) {
    // Select strategy
    $("input[name='strategy'][value='" + config.bidding_approach + "']").prop("checked", true);

    // Select whitelist
    if (!config.black_list) {
      enableAndSetList("whitelist", config.white_list);
      disableList("blacklist");
    } else {
      enableAndSetList("blacklist", config.black_list);
      disableList("whitelist");
    }

    // Select layout
    $("input[name='layout'][value='" + config.layout_approach + "']").prop("checked", true)

    // Bind handlers
    $("input[name='strategy']").off().change(function(event) {
      config.bidding_approach = $(event.currentTarget).val();
      saveConfig(config);
    });
    $("input[name='listing'][value='whitelist']").off().change(function() {
      $("#whitelist input[type='text']").prop("disabled", false);
      $("#blacklist input[type='text']").prop("disabled", true);

      config.white_list = $("#whitelist input[type='text']").val();
      config.black_list = "";

      saveConfig(config);
    });
    $("#whitelist input[type='text']").off().focusout(function() {
      config.white_list = $("#whitelist input[type='text']").val();
      config.black_list = "";

      saveConfig(config);
    });
    $("input[name='listing'][value='blacklist']").off().change(function() {
      $("#whitelist input[type='text']").prop("disabled", true);
      $("#blacklist input[type='text']").prop("disabled", false);

      config.white_list = "";
      config.black_list = $("#blacklist input[type='text']").val();

      saveConfig(config);
    });
    $("#blacklist input[type='text']").off().focusout(function() {
      config.white_list = "";
      config.black_list = $("#blacklist input[type='text']").val();

      saveConfig(config);
    });
    $("input[name='layout']").off().change(function(event) {
      config.layout_approach = $(event.currentTarget).val();

      saveConfig(config, true);
    });
    $("select#city").change(function(event) {
      update_preview(config);
    });

    update_preview(config);
  }

  function saveConfig(config, skip_update_preview) {
    $.post("/api/saveconfig", {
      "p_id": config.page,
      "c_id": config.id,
      "name": config.name,
      "traffic_percentage": config.traffic_percentage,
      "bidding_approach": config.bidding_approach,
      "layout_approach": config.layout_approach,
      "white_list": config.white_list,
      "black_list": config.black_list
    });

    if (!skip_update_preview) {
      update_preview(config);
    }
  }

  function createConfiguration(page, config) {
    var id = config.id;
    var name = config.name;
    var traffic = config.traffic_percentage;
    var configuration = $('<div><span class="radio-box"><input type="radio" name="config" value="' + id + '"><input class="config_name" type="text" value="' + name + '"></span><input class="percentage" type="text" size="3" value="' + traffic + '" style="text-align: center"> % traffic</div>');
    $(".config_name", configuration).focusout(function(event) {
      config.name = $(event.currentTarget).val();
      saveConfig(config);
    });
    $(".percentage", configuration).focusout(function(event) {
      config.traffic_percentage = $(event.currentTarget).val();
      saveConfig(config);
    });
    $(".page-box").append(configuration);
    configuration.change(function() {
      loadConfiguration(page, id);
    });
  }

  function selectConfiguration(name) {
    $("input[name='config'][value='" + name + "']").prop("checked", true);
  }

  function loadConfiguration(page, id) {
    selectConfiguration(id);

    for (var i = 0; i < page.length; i++) {
      if (page[i].id == id) {
        loadConfig(page, page[i]);
      }
    }
  }

  $.getJSON("/api/readpagelist", function(data) {
    if (data.data.length == 0) {
      $.getJSON("/api/createpage?name=unnamed", function(data) {
        $.getJSON("/api/createconfig?p_id=" + data.data.p_id + "&name=unnamed", function(data) {
	  var page = [ data.data ];
          createConfiguration(page, page[0]);
          loadConfiguration(page, page[0].id);
        });

        $("#add-configuration-button").off().click(function() {
          $.getJSON("/api/createconfig?p_id=" + data.data.p_id + "&name=unnamed", function(data) {
              page.push(data.data);
              createConfiguration(page, data.data);
          });
        });
      });
      return;
    }

    $.getJSON("/api/readpage?p_id=" + data.data[0].id, function(data) {
      var page = data.data;
      for (var i = 0; i < page.length; i++) {
        createConfiguration(page, page[i]);
      }
      loadConfiguration(page, page[0].id);

      $("#add-configuration-button").off().click(function() {
        $.getJSON("/api/createconfig?p_id=" + data.data[0].id + "&name=unnamed", function(data) {
            page.push(data.data);
            createConfiguration(page, data.data);
        });
      });
    });  
  });

  function update_preview(config) {
    $("#preview").fadeIn();
    $(".layout-template").remove();

    var ip = $("select#city option:selected").val();
    var c_id = config.id;
    $.getJSON("/api/getdeals?ip=" + ip + "&c_id=" +c_id, function(data) {
      $("#target").append(render_single_layout(data.data[0]).addClass("layout-template"));
      $("#target2").append(render_double_layout(data.data[0], data.data[1]).addClass("layout-template"));
      $("#target3").append(render_double_layout2(data.data[0], data.data[1]).addClass("layout-template"));

      $("#preview").fadeOut();
    });
  }

  function render_single_layout(data) {
    var image = $("<img style='width: 100%'/>").attr("src", data.image_url);
    var title = $("<div/>").text(data.title).css("font-size", "18px")
        .css("margin-bottom", "5px").css("border-bottom", "1px black solid")
        .css("white-space", "nowrap").css("overflow", "hidden").css("text-overflow", "ellipsis");
    var discount_rate = Math.floor((data.current_price / data.list_price) * 100) / 10;
    var discount_div = $("<div/>").text(discount_rate + "折").css("float", "left").css("width", "45%").css("font-size", "26px");
    var current_price = $("<div/>").text("现价:"+data.current_price);
    var list_price = $("<div/>").html("原价:<s>" + data.list_price + "</s>");
    var city = $("<div/>").text("城市:"+data.city);
    var div = $("<div/>").css("float", "right").css("width", "45%").append(current_price).append(list_price).append(city);
    var link = $("<a/>").attr("href", data.deal_url).attr("target", "_blank");
    var content = $("<div/>").css("display", "inline-block").css("width", "160px").css("margin", "10px")
        .append(image).append(title).append(discount_div).append(div);
    return link.append(content);
  }

  var animation_msec = 4000;
			  
  function render_double_layout(data1, data2) {
    var div1 = render_single_layout(data1);
    var div2 = render_single_layout(data2).css("position", "absolute").css("left", "0").css("top", "0").css("opacity", "0");
    var func1 = function() {
      div1.animate({opacity: 0}, {duration: animation_msec});
      div2.animate({opacity: 1}, {duration: animation_msec});
    }
    var func2 = function() {
      div1.animate({opacity: 1}, {duration: animation_msec});
      div2.animate({opacity: 0}, {duration: animation_msec});
    }

    var func = true;
    setInterval(function() {
      if (func) {
        func1();
      } else {
        func2();
      };
      func = !func;
    }, 2000);
    return $("<div/>").css("position", "relative").append(div1).append(div2);
  }

  function render_double_layout2(data1, data2) {
    var div1 = render_single_layout(data1).css("opacity", "0");
    var div2 = render_single_layout(data1).css("position", "absolute").css("left", "0").css("top", "0");
    var div3 = render_single_layout(data2).css("position", "absolute").css("left", "190px").css("top", "0");
    var func3 = function() {
      div2.animate({left: "-190px"}, {duration: animation_msec, complete: function() {
        div2.css("left", "190px");
      }});
      div3.animate({left: "0px"}, {duration: animation_msec});
    }
    var func4 = function() {
      div3.animate({left: "-190px"}, {duration: animation_msec, complete: function() {
        div3.css("left", "190px");
      }});
      div2.animate({left: "0px"}, {duration: animation_msec});
    }

    var func5 = true;
    setInterval(function() {
      if (func5) {
        func3();
      } else {
        func4();
      };
      func5 = !func5;
    }, 2000);
    return $("<div/>").css("position", "relative").append(div1).append(div2).append(div3);
  }
</script>
{% endblock %}
