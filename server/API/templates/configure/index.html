
{% extends "base.html" %}
{% load i18n %}

{% block content %}
<style>
  .configuration-box {
    width: 800px;
  }
  
  .page-box {
    box-shadow: 0px 1px 4px 0px rgba(0,0,0,0.2);
    padding: 20px;
    margin: 10px;
  }

  .config-box {
    box-shadow: 0px 1px 4px 0px rgba(0,0,0,0.2);
    padding: 20px;
    margin: 10px;
  }

  .section {
    margin: 10px 0;
  }

  .section-header {
    border-bottom: 1px black solid;
    font-size: larger;
    margin-bottom: 15px;
    padding-bottom: 5px;
  }

  .radio-box {
    margin-right: 10px;
  }

  .radio-box input {
    margin-right: 10px;
  }

  .layout-box {
    display: inline-block;
    border: 1px black solid;
    height: 50px;
    width: 50px;
  }
</style>

<div class="configuration-box">
  <div class="page-box">
    <button id="add-configuration-button" style="margin-bottom: 15px">Add Configuration</button>
  </div>
  
  <div class="config-box">
    <!-- Bid strategy -->
    <div class="section">
      <div class="section-header">Bid Strategy</div>
      <div>
	<span class="radio-box">
	  <input type="radio" name="strategy" value="0">Bid Strategy 1
	</span>
      </div>
      <div>
	<span class="radio-box">
	  <input type="radio" name="strategy" value="1">Bid Strategy 2
	</span>
      </div>
    </div>
    
    <!-- Black/White list -->
    <div class="section">
      <div class="section-header">Site control</div>
      <div id="whitelist">
	<span class="radio-box">
	  <input type="radio" name="listing" value="whitelist">Whitelist
	</span>
	<input type="text" size="120">
      </div>
      <div id="blacklist">
	<span class="radio-box">
	  <input type="radio" name="listing" value="blacklist">Blacklist
	</span>
	<input type="text" size="120 disabled">
      </div>
    </div>
    
    <!-- Layout option -->
    <div class="section">
      <div class="section-header">Layout</div>
      <div>
	<span class="radio-box">
	  <input type="radio" name="layout" value="0">Single
	</span>
      </div>
      <div>
	<span class="radio-box">
	  <input type="radio" name="layout" value="1">Multiple
	</span>
      </div>
      <div>
	<span class="radio-box">
	  <input type="radio" name="layout" value="2">Many
	</span>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  function createPage() {
    var fakeCreatePageResposne = {
      "status": "ok",
      "data": {
        "p_id": "0",
      },
      "error": ""
    }
  }

  function readPageList() {

  }

  function readPage(page) {

  }

  function savePage(page) {

  }

  function createConfig(page) {
    var fakeCreateConfigResponse = {
      "status": "ok",
      "data": {
        "id": 0,
        "bid_strategy": 0,
        "whitelist": "whitelist_site_1, whitelist_site_2",
        "blacklist": "",
        "layout": 0
      },
      "error": ""
    }
  }

  function enableAndSetList(list_name, val) {
    $("input[name='listing'][value='" + list_name + "']").prop("checked", true);
    $("#" + list_name + " input[type='text']").prop("disabled", false);
    $("#" + list_name + " input[type='text']").val(val);
  }

  function disableList(list_name) {
    $("#" + list_name + " input[type='text']").prop("disabled", true);
    $("#" + list_name + " input[type='text']").val("");
  }

  function loadConfig(page, config) {
    // Select strategy
    $("input[name='strategy'][value='" + config.bidding_approach + "']").prop("checked", true);

    // Select whitelist
    if (!config.black_list) {
      enableAndSetList("whitelist", config.white_list);
      disableList("blacklist");
    } else {
      enableAndSetList("blacklist", config.black_list);
      disableList("whitelist");
    }

    // Select layout
    $("input[name='layout'][value='" + config.layout_approach + "']").prop("checked", true)

    // Bind handlers
    $("input[name='strategy']").off().change(function(event) {
      config.bidding_approach = $(event.currentTarget).val();
      saveConfig(config);
    });
    $("input[name='listing'][value='whitelist']").off().change(function() {
      $("#whitelist input[type='text']").prop("disabled", false);
      $("#blacklist input[type='text']").prop("disabled", true);

      config.white_list = $("#whitelist input[type='text']").val();
      config.black_list = "";

      saveConfig(config);
    });
    $("#whitelist input[type='text']").off().focusout(function() {
      config.white_list = $("#whitelist input[type='text']").val();
      config.black_list = "";

      saveConfig(config);
    });
    $("input[name='listing'][value='blacklist']").off().change(function() {
      $("#whitelist input[type='text']").prop("disabled", true);
      $("#blacklist input[type='text']").prop("disabled", false);

      config.white_list = "";
      config.black_list = $("#blacklist input[type='text']").val();

      saveConfig(config);
    });
    $("#blacklist input[type='text']").off().focusout(function() {
      config.white_list = "";
      config.black_list = $("#blacklist input[type='text']").val();

      saveConfig(config);
    });
    $("input[name='layout']").off().change(function(event) {
      config.layout_approach = $(event.currentTarget).val();

      saveConfig(config);
    });
  }

  function saveConfig(config) {
    $.post("/api/saveconfig", {
      "p_id": config.page,
      "c_id": config.id,
      "name": config.name,
      "bidding_approach": config.bidding_approach,
      "layout_approach": config.layout_approach,
      "white_list": config.white_list,
      "black_list": config.black_list
    });
  }

  function createConfiguration(page, config) {
    var id = config.id;
    var name = config.name;
    var traffic = config.traffic_percentage;
    var configuration = $('<div><span class="radio-box"><input type="radio" name="config" value="' + id + '"><input class="config_name" type="text" value="' + name + '"></span><input class="percentage" type="text" size="3" value="' + traffic + '" style="text-align: center"></div>');
    $(".config_name", configuration).focusout(function(event) {
      config.name = $(event.currentTarget).val();
      saveConfig(config);
    });
    $(".percentage", configuration).focusout(function(event) {
      config.percentage = $(event.currentTarget).val();
      saveConfig(config);
    });
    $(".page-box").append(configuration);
    configuration.change(function() {
      loadConfiguration(page, id);
    });
  }

  function selectConfiguration(name) {
    $("input[name='config'][value='" + name + "']").prop("checked", true);
  }

  function loadConfiguration(page, id) {
    selectConfiguration(id);

    for (var i = 0; i < page.length; i++) {
      if (page[i].id == id) {
        loadConfig(page, page[i]);
      }
    }
  }

  $.getJSON("/api/readpagelist", function(data) {
    if (data.data.length == 0) {
      $.getJSON("/api/createpage?name=unnamed", function(data) {
        $.getJSON("/api/createconfig?p_id=" + data.data.p_id + "&name=unnamed", function(data) {
	  var page = [ data.data ];
          createConfiguration(page, page[0]);
          loadConfiguration(page, page[0].id);
        });

        $("#add-configuration-button").off().click(function() {
          $.getJSON("/api/createconfig?p_id=" + data.data.p_id + "&name=unnamed", function(data) {
              page.push(data.data);
              createConfiguration(page, data.data);
          });
        });
      });
      return;
    }

    $.getJSON("/api/readpage?p_id=" + data.data[0].id, function(data) {
      var page = data.data;
      for (var i = 0; i < page.length; i++) {
        createConfiguration(page, page[i]);
      }
      loadConfiguration(page, page[0].id);

      $("#add-configuration-button").off().click(function() {
        $.getJSON("/api/createconfig?p_id=" + data.data[0].id + "&name=unnamed", function(data) {
            page.push(data.data);
            createConfiguration(page, data.data);
        });
      });
    });  
  });

</script>
{% endblock %}
